name: firebase deploy

on:
  push:
    paths:
      - 'src/**'
      - '.github/workflows/nodejs.yml'
      - 'package-lock.json'
      - 'firebase.json'
      - '.firebaserc'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: '${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  build:
    name: ğŸ— Build
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Set up code
        uses: actions/checkout@v3

      - name: â” Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: lts/*
          cache: npm

      - name: ğŸ“¥ Download dependencies
        run: npm ci

      - name: ğŸ— Run build script
        run: npm run build

  unit-test:
    name: ğŸ§ª Unit tests
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Set up code
        uses: actions/checkout@v3

      - name: â” Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: lts/*
          cache: npm

      - name: ğŸ“¥ Download dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: npm test

  deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: dev
    if: github.ref == 'refs/heads/dev'

    steps:
      - name: â¬‡ï¸ Set up code
        uses: actions/checkout@v3

      - name: ğŸ—ï¸ Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v0
        with:
          access_token_scopes: 'email, openid, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/firebase'
          workload_identity_provider: ${{ secrets.IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
          token_format: 'access_token'
          create_credentials_file: true

      - name: ğŸ—ï¸ Authenticate Docker to Google Cloud
        uses: docker/login-action@v1
        with:
          registry: us-central1-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: ğŸ·ï¸ Extract tags from GitHub
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: us-central1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/images/job
          tags: |
            latest

      - name: ğŸ”° Setup pack
        uses: buildpacks/github-actions/setup-pack@v4.8.0

      - name: ğŸ“¦ Build image
        shell: bash
        run: pack build job --builder gcr.io/buildpacks/builder -t ${{ steps.meta.outputs.tags }}

      - name: ğŸº Push images to artifact registry
        shell: bash
        run: docker push ${{ steps.meta.outputs.tags }}

      # - name: ğŸ•°ï¸ Create Cloud Scheduler
      #   run: |
      #     if [ ! "$(gcloud scheduler jobs list --location=us-central1 | grep rdcc-weekly-email)" ]; then
      #       gcloud scheduler jobs create http rdcc-weekly-email \
      #         --description="Trigger the rdcc-weekly-email bot once a week on monday morning" \
      #         --schedule="0 5 * * MON" \
      #         --time-zone=America/Denver \
      #         --uri=$(gcloud run services describe app --region us-central1 --format 'value(status.url)') \
      #         --http-method=POST \
      #         --max-retry-attempts=0 \
      #         --min-backoff=30m \
      #         --max-backoff=1h \
      #         --max-doublings=1 \
      #         --attempt-deadline=30m \
      #         --oidc-service-account-email=cloud-scheduler-sa@${{ secrets.PROJECT_ID }}.iam.gserviceaccount.com \
      #         --location=us-central1 \
      #         --quiet
      #     else
      #       gcloud scheduler jobs update http app \
      #         --description="Trigger the app bot once a week on monday morning" \
      #         --schedule="0 5 * * MON" \
      #         --time-zone=America/Denver \
      #         --uri=$(gcloud run services describe app --region us-central1 --format 'value(status.url)') \
      #         --http-method=POST \
      #         --max-retry-attempts=0 \
      #         --min-backoff=30m \
      #         --max-backoff=1h \
      #         --max-doublings=1 \
      #         --attempt-deadline=30m \
      #         --oidc-service-account-email=cloud-scheduler-sa@${{ secrets.PROJECT_ID }}.iam.gserviceaccount.com \
      #         --location=us-central1 \
      #         --quiet
      #     fi

      # - name: â˜ï¸ Deploy cloud function
      #   id: function
      #   uses: google-github-actions/deploy-cloud-functions@main
      #   with:
      #     env_vars: SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }},SENDGRID_TEMPLATE=${{ secrets.SENDGRID_TEMPLATE }},EMAIL_RECIPIENT=${{ secrets.EMAIL_RECIPIENT }}

  deploy-prod:
    runs-on: ubuntu-latest
    environment:
      name: prod
    if: github.ref == 'refs/heads/main'

    steps:
      - name: â¬‡ï¸ Set up code
        uses: actions/checkout@v2

      - name: â” Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: lts/*
          cache: npm

      - name: ğŸ“¥ Download dependencies
        run: npm ci

      - name: ğŸ— Run build script
        run: npm run build

      - name: ğŸª£ Cache firebase
        uses: actions/cache@v2
        with:
          path: ./.firebase
          key: ${{ runner.OS }}-firebase-${{ hashFiles('**/*.cache') }}
          restore-keys: |
            ${{ runner.OS }}-firebase-
            ${{ runner.OS }}-

      - name: ğŸš€ Firebase Deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.SERVICE_ACCOUNT }}'
          channelId: live
          projectId: '${{ secrets.PROJECT_ID }}'
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
